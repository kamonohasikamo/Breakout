<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>GameCanvas</title>
		<style>
			*{padding:0; margin: 0; }
			canvas {background: #eee; display: block; margin: 0 auto; }
		</style>
	</head>
	<body>
		<canvas id="myCanvas" width="500" height="480"></canvas>
		<script>
			// canvas要素への参照
			var canvas = document.getElementById("myCanvas");
			// 2D描画コンテキストを保存する変数
			var ctx = canvas.getContext("2d");

			//=========================================
			// Ball Definition
			//=========================================
			var ball_x = canvas.width / 2;
			var ball_y = canvas.height - 30;
			var dx = 2;
			var dy = -2;
			var ballRadius = 10;
			
			//=========================================
			// Paddle Definition
			//=========================================
			var paddleHeight = 10;
			var paddleWidth = 75;
			var paddleX = (canvas.width - paddleWidth) / 2;

			//=========================================
			// Paddle Moving Definition
			//=========================================
			var isOnPressRight = false;
			var isOnPressLeft = false;

			//=========================================
			// Block Definition
			//=========================================
			var blockRowCount = 3;
			var blockColumnCount = 5;
			var blockWidth = 75;
			var blockHeight = 20;
			var blockPadding = 10;
			var blockOffsetTop = 30;
			var blockOffsetLeft = 30;
			var blocks = [];
			for(var i = 0; i < blockColumnCount; i++) {
				blocks[i] = [];
				for(var j = 0; j < blockRowCount; j++) {
					blocks[i][j] = { x: 0, y: 0, status: 1};
				}
			}

			//=========================================
			// score Definition
			//=========================================
			var gameScore = 0;

			//=========================================
			// LevelDesign Definition
			//=========================================
			var LevelDesign = 1;
			var firstUpFlag = false;
			var secondUpFlag = false;

			function drawGameScore() {
				ctx.font = "16px Arial";
				ctx.fillStyle = "black";
				ctx.fillText("Score: " + gameScore, 8, 20);
			}

			//=========================================
			// Block衝突検出処理
			//=========================================
			function blockCollisionJudgment() {
				for (var i = 0; i < blockColumnCount; i++) {
					for (var j = 0; j < blockRowCount; j++) {
						/*
							当たり判定処理
							・ボールのx座標がブロックのx座標より大きい
							・ボールのx座標がブロックのx座標とその幅の和より小さい
							・ボールのy座標がブロックのy座標より大きい
							・ボールのy座標がブロックのy座標とその高さの和より小さい
						*/
						var checkBlock = blocks[i][j];
						if (checkBlock.status == 1) {
							if (ball_x > checkBlock.x
							&&  ball_x < checkBlock.x + blockWidth
							&&  ball_y > checkBlock.y
							&&  ball_y < checkBlock.y + blockHeight) {
								dy = -dy;
								checkBlock.status = 0;
								gameScore++;
								if (gameScore > 5 && firstUpFlag == false) {
									LevelDesign *= 2;
									firstUpFlag = true;
								}
								if (gameScore > 9 && secondUpFlag == false) {
									LevelDesign *= 2;
									secondUpFlag = true;
								}
								if (gameScore == blockRowCount * blockColumnCount) {
									alert("GameClear!\nYOU WIN, CONGRATULATIONS!");
									document.location.reload();
								}
							}
						}
					}
				}
			}

			function drawBlocks() {
				for (var i = 0; i < blockColumnCount; i++) {
					for (var j = 0; j < blockRowCount; j++) {
						if (blocks[i][j].status == 1) {
							var blockX = (i * (blockWidth + blockPadding)) + blockOffsetLeft;
							var blockY = (j * (blockHeight + blockPadding)) + blockOffsetTop;
							blocks[i][j].x = blockX;
							blocks[i][j].y = blockY;
							ctx.beginPath();
							ctx.rect(blockX, blockY, blockWidth, blockHeight);
							ctx.fillStyle = "#0095DD";
							ctx.fill();
							ctx.closePath();
						}
					}
				}
			}

			function OnPressKey(e) {
				if (e.key == "Right" || e.key == "ArrowRight") {
					isOnPressRight = true;
				} else if (e.key == "Left" || e.key == "ArrowLeft") {
					isOnPressLeft = true;
				}
			}

			function UpKey(e) {
				if (e.key == "Right" || e.key == "ArrowRight") {
					isOnPressRight = false;
				} else if (e.key == "Left" || e.key == "ArrowLeft") {
					isOnPressLeft = false;
				}
			}

			function drawPaddle() {
				ctx.beginPath();
				ctx.rect(paddleX, canvas.height - paddleHeight, paddleWidth, paddleHeight);
				ctx.fillStyle = "#0095DD"
				ctx.fill();
				ctx.closePath();
			}
			
			function drawBall() {
				ctx.beginPath();
				ctx.arc(ball_x, ball_y, ballRadius, 0, Math.PI*2);
				ctx.fillStyle = "#0095DD";
				ctx.fill();
				ctx.closePath();
			}
			
			function draw() {
				// clear Ball Trajectory
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				drawBall();
				drawBlocks();
				drawGameScore();
				drawPaddle();
				blockCollisionJudgment();

				// 跳ね返りの判定
				if (ball_y + dy < ballRadius) {
					dy = -dy;
				} else if (ball_y + dy > canvas.height - ballRadius) {
					if(ball_x > paddleX && ball_x < paddleX + paddleWidth) {
						dy = -dy;
					} else {
						alert("GAME OVER!!!!");
						document.location.reload();
						clearInterval(interval); // Needed for chrome to end game
					}
				}

				if (ball_x + dx < ballRadius || ball_x + dx > canvas.width - ballRadius) {
					dx = -dx
				}

				ball_x += dx * LevelDesign;
				ball_y += dy * LevelDesign;

				// Paddle Moving
				if (isOnPressRight && paddleX < canvas.width - paddleWidth) {
					paddleX += 7;
				} else if (isOnPressLeft && paddleX > 0) {
					paddleX -= 7;
				}

			}

			// addEventListener 
			// ボタンが押されたときに発火
			document.addEventListener("keydown", OnPressKey, false);
			// addEventListener 
			// ボタンが離れたときに発火
			document.addEventListener("keyup", UpKey, false);
			// draw関数が10msごとに実行される
			var interval = setInterval(draw, 10);
		</script>
	</body>
</html>